-- ===================================================================
-- 1) ìˆ˜ì—…ì•ˆ ì¡°íšŒ: lesson_plans_adminì„ is_admin() ì‚¬ìš©ìœ¼ë¡œ ë³€ê²½
--    â†’ name/is_adminìœ¼ë¡œ adminì¸ ê³„ì •(ì˜ˆ: ìµœì§€í›ˆ)ë„ ìˆ˜ì—…ì•ˆ ì¡°íšŒ ê°€ëŠ¥
-- 2) ë¦¬í¬íŠ¸ ê³µê°œ: ë¹„ë¡œê·¸ì¸(anon)ì´ ê²€ìˆ˜ì™„ë£Œëœ ì„¸ì…˜ë§Œ ì¡°íšŒ ê°€ëŠ¥
--    â†’ /report/[id] ë§í¬ë¥¼ í•™ë¶€ëª¨ ë“±ì´ ë¡œê·¸ì¸ ì—†ì´ ë³¼ ìˆ˜ ìˆìŒ
-- ===================================================================

-- ---------------------------------------------------------------------
-- 1. lesson_plans: Admin ì •ì±…ì„ is_admin() ì‚¬ìš©ìœ¼ë¡œ ë³€ê²½
-- ---------------------------------------------------------------------
-- (is_admin() í•¨ìˆ˜ê°€ ì—†ìœ¼ë©´ ë¨¼ì € EXECUTE_FIX_ALL_ADMIN_RLS.sql 1ë‹¨ê³„ ì‹¤í–‰)
DROP POLICY IF EXISTS lesson_plans_admin ON lesson_plans;
CREATE POLICY lesson_plans_admin ON lesson_plans
  FOR SELECT
  USING (is_admin());

SELECT 'âœ… lesson_plans_admin ì •ì±… ìˆ˜ì • ì™„ë£Œ (is_admin() ì‚¬ìš©)' AS status;

-- ---------------------------------------------------------------------
-- 2. sessions: anonì´ ê²€ìˆ˜ì™„ë£Œ(status=verified)ëœ ì„¸ì…˜ë§Œ SELECT ê°€ëŠ¥
-- ---------------------------------------------------------------------
CREATE POLICY "sessions_select_anon_verified" ON sessions
  FOR SELECT TO anon
  USING (status = 'verified');

SELECT 'âœ… sessions anon ì •ì±… ì¶”ê°€ ì™„ë£Œ (ê²€ìˆ˜ì™„ë£Œë§Œ ê³µê°œ)' AS status;

-- ---------------------------------------------------------------------
-- 3. users: anonì´ "ê²€ìˆ˜ì™„ë£Œëœ ì„¸ì…˜ì˜ ë‹´ë‹¹ ì„ ìƒë‹˜" ì •ë³´ë§Œ SELECT ê°€ëŠ¥
--           (ë¦¬í¬íŠ¸ í˜ì´ì§€ì—ì„œ ì„ ìƒë‹˜ ì´ë¦„ í‘œì‹œìš©)
-- ---------------------------------------------------------------------
CREATE POLICY "users_select_anon_verified_creator" ON users
  FOR SELECT TO anon
  USING (
    EXISTS (
      SELECT 1 FROM sessions s
      WHERE s.created_by = users.id
        AND s.status = 'verified'
    )
  );

SELECT 'âœ… users anon ì •ì±… ì¶”ê°€ ì™„ë£Œ (ê²€ìˆ˜ì™„ë£Œ ì„¸ì…˜ ë‹´ë‹¹ìë§Œ)' AS status;

-- ===================================================================
-- ì™„ë£Œ
-- ===================================================================
SELECT 'ğŸ‰ ìˆ˜ì—…ì•ˆ ì¡°íšŒ + ë¦¬í¬íŠ¸ ì™¸ë¶€ ê³µê°œ RLS ì ìš© ì™„ë£Œ' AS final_status;
