<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play Phase - Immersive Actions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            background-color: #000; 
            font-family: 'Pretendard', sans-serif;
        }

        .immersive-container {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .immersive-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }

        .image-active {
            display: block;
        }

        #start-overlay {
            position: absolute;
            inset: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            cursor: pointer;
        }

        #intro-overlay {
            position: absolute;
            inset: 0;
            background: #000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 90;
            color: white;
        }

        .text-focus-in {
            animation: text-focus-in 0.8s cubic-bezier(0.550, 0.085, 0.680, 0.530) both;
        }

        @keyframes text-focus-in {
            0% { filter: blur(15px); opacity: 0; transform: scale(0.8); }
            100% { filter: blur(0px); opacity: 1; transform: scale(1); }
        }

        .vignette {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle, transparent 50%, rgba(0,0,0,0.6) 150%);
            pointer-events: none;
            z-index: 20;
        }

        .progress-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 30;
        }

        .progress-segment {
            width: 40px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            transition: all 0.3s;
        }

        .progress-segment.active {
            background: rgba(59, 130, 246, 1);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        .progress-segment.completed {
            background: rgba(34, 197, 94, 1);
        }

        .action-counter {
            position: fixed;
            top: 20px;
            right: 20px;
            color: rgba(255,255,255,0.5);
            font-size: 14px;
            z-index: 30;
        }
    </style>
</head>
<body>
    <!-- ì‹œì‘ ì „ ëŒ€ê¸° í™”ë©´ -->
    <div id="start-overlay" onclick="handleStart()">
        <h1 class="text-5xl font-black text-orange-600 mb-6 tracking-tighter">PLAY PHASE</h1>
        <div class="px-8 py-3 bg-white/10 rounded-full text-white text-xl animate-pulse">
            í™”ë©´ì„ í´ë¦­í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”
        </div>
    </div>

    <!-- ì¸íŠ¸ë¡œ ì˜¤ë²„ë ˆì´ -->
    <div id="intro-overlay">
        <div class="text-center text-focus-in">
            <h2 id="intro-text-en" class="text-[10rem] font-black leading-none mb-4"></h2>
            <p id="intro-text-ko" class="text-6xl font-bold text-blue-400 mt-6"></p>
        </div>
    </div>

    <!-- ë©”ì¸ ì´ë¯¸ì§€ ì˜ì—­ -->
    <div class="immersive-container">
        <img id="img-off" class="immersive-image" alt="OFF">
        <img id="img-on" class="immersive-image" alt="ON">
    </div>

    <!-- ì§„í–‰ í‘œì‹œ (15ê°œ ì„¸ê·¸ë¨¼íŠ¸) -->
    <div class="progress-indicator" id="progress-indicator"></div>

    <!-- ì•¡ì…˜ ì¹´ìš´í„° -->
    <div class="action-counter" id="action-counter">ACTION 1/15</div>

    <div class="vignette"></div>

    <script>
        const supabaseUrl = 'https://mwgvserdyflsqyhcqecp.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13Z3ZzZXJkeWZsc3F5aGNxZWNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ2NzY4MDAsImV4cCI6MjA1MDI1MjgwMH0.7qJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJq';
        const supabase = window.supabase?.createClient(supabaseUrl, supabaseAnonKey) || null;

        const config = {
            stepTime: 500, // 0.5ì´ˆ (500ms)
            introTime: 2000, // 2ì´ˆ ì¸íŠ¸ë¡œ
            actionDuration: 10000 // 10ì´ˆ (10ë²ˆ ë°˜ë³µ)
        };

        let scenarioData = null;
        let currentActionIndex = 0;
        let isRunning = false;
        let toggleState = false;
        let actionInterval = null;
        let progressInterval = null;

        // 15ê°œ ë™ì‘ íƒ€ì… ì •ì˜
        const ACTION_TYPES = [
            'POINT', 'KNOCK', 'CHOP', 'TOUCH', 'PUSH',
            'CLAP', 'PULL', 'SWIPE', 'SNAP', 'GRAB',
            'WALK', 'JUMP', 'LEAN', 'SHRINK', 'EXPLODE'
        ];

        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const params = new URLSearchParams(window.location.search);
        let scenarioId = params.get('scenarioId') || 'week1_kitchen'; // INIT_PHASEì—ì„œ ë°›ì€ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•˜ë„ë¡ letìœ¼ë¡œ ë³€ê²½
        const token = params.get('token');
        const phaseIndex = parseInt(params.get('phaseIndex') || '0');
        
        // ì‹œì‘ ìƒíƒœ ì¶”ì  (ë¬´í•œ ê¹œë¹¡ê±°ë¦¼ ë°©ì§€)
        let isStarted = false;
        let isStarting = false;

        // ë¶€ëª¨ì—ê²Œ PHASE_READY ì „ì†¡
        function sendPhaseReady() {
            window.parent.postMessage({
                type: 'PHASE_READY',
                phase: 'play'
            }, '*');
        }

        // ë¶€ëª¨ì—ê²Œ PHASE_PROGRESS ì „ì†¡
        function sendPhaseProgress(progress) {
            window.parent.postMessage({
                type: 'PHASE_PROGRESS',
                phase: 'play',
                progress: progress
            }, '*');
        }

        // ë¶€ëª¨ì—ê²Œ PHASE_COMPLETE ì „ì†¡
        function sendPhaseComplete() {
            window.parent.postMessage({
                type: 'PHASE_COMPLETE',
                phase: 'play',
                elapsedTime: config.actionDuration * ACTION_TYPES.length
            }, '*');
        }

        // INIT_PHASE ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ (í•œ ë²ˆë§Œ ì‹¤í–‰)
        let initPhaseReceived = false;
        window.addEventListener('message', (event) => {
            if (event.data.type === 'INIT_PHASE' && event.data.phase === 'play' && !initPhaseReceived) {
                initPhaseReceived = true;
                const data = event.data.data;
                
                // INIT_PHASEì—ì„œ ë°›ì€ scenarioIdë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ìš°ì„ ìˆœìœ„ ë†’ìŒ)
                if (data.scenarioId) {
                    scenarioId = data.scenarioId;
                    console.log('ğŸ“¥ [Play Phase] INIT_PHASEì—ì„œ scenarioId ë°›ìŒ:', scenarioId);
                }
                
                // ì˜¤ë²„ë ˆì´ ì¦‰ì‹œ ì œê±°
                removeStartOverlay();
                
                if (data.scenarioId) {
                    loadScenario(data.scenarioId).then(() => {
                        // ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ ì™„ë£Œ í›„ scenarioData ê²€ì¦
                        if (!scenarioData || !scenarioData.actions || scenarioData.actions.length === 0) {
                            console.warn('âš ï¸ [Play Phase] ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ ì™„ë£Œí–ˆì§€ë§Œ ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŒ, ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©');
                            scenarioData = null; // handleStartì—ì„œ ê¸°ë³¸ ë°ì´í„° ìƒì„±í•˜ë„ë¡
                        } else {
                            console.log('âœ… [Play Phase] ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ ì™„ë£Œ, ì•¡ì…˜ ìˆ˜:', scenarioData.actions.length);
                        }
                        
                        // ìë™ ì‹œì‘
                        setTimeout(() => {
                            handleStart();
                        }, 300);
                    }).catch((error) => {
                        console.error('âŒ [Play Phase] ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ ë°ì´í„°ë¡œ ì‹œì‘:', error);
                        // ê¸°ë³¸ ë°ì´í„°ë¡œ ì‹œì‘
                        scenarioData = null; // handleStartì—ì„œ ê¸°ë³¸ ë°ì´í„° ìƒì„±í•˜ë„ë¡
                        setTimeout(() => {
                            handleStart();
                        }, 300);
                    });
                } else {
                    // scenarioIdê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ë°ì´í„°ë¡œ ì‹œì‘
                    console.log('âš ï¸ [Play Phase] scenarioId ì—†ìŒ, ê¸°ë³¸ ë°ì´í„°ë¡œ ì‹œì‘');
                    scenarioData = null; // handleStartì—ì„œ ê¸°ë³¸ ë°ì´í„° ìƒì„±í•˜ë„ë¡
                    setTimeout(() => {
                        handleStart();
                    }, 300);
                }
            }
        });

        // ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ
        async function loadScenario(id) {
            try {
                if (supabase) {
                    const { data, error } = await supabase
                        .from('play_scenarios')
                        .select('*')
                        .eq('id', id)
                        .single();

                    if (error) throw error;
                    if (data && data.scenario_json) {
                        scenarioData = data.scenario_json;
                        console.log('âœ… ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ ì„±ê³µ:', scenarioData);
                        
                        // ì´ë¯¸ì§€ URLì´ ë¹„ì–´ìˆì„ ê²½ìš° placeholder ì‚¬ìš©
                        if (scenarioData.actions) {
                            scenarioData.actions = scenarioData.actions.map(action => {
                                if (!action.images || !action.images.off || !action.images.on) {
                                    return {
                                        ...action,
                                        images: {
                                            off: action.images?.off || `https://via.placeholder.com/1920x1080/000000/FFFFFF?text=${action.type}_OFF`,
                                            on: action.images?.on || `https://via.placeholder.com/1920x1080/FF6600/FFFFFF?text=${action.type}_ON`
                                        }
                                    };
                                }
                                return action;
                            });
                        }
                    }
                } else {
                    // Supabaseê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©
                    scenarioData = {
                        theme: 'kitchen',
                        actions: ACTION_TYPES.map((type, index) => ({
                            type,
                            startTime: index * 13, // ì¸íŠ¸ë¡œ 2ì´ˆ + ì•¡ì…˜ 10ì´ˆ + ì—¬ìœ  1ì´ˆ
                            duration: 10,
                            introText: { en: type, ko: getActionKoreanName(type) },
                            images: {
                                off: `https://via.placeholder.com/1920x1080/000000/FFFFFF?text=${type}_OFF`,
                                on: `https://via.placeholder.com/1920x1080/FF6600/FFFFFF?text=${type}_ON`
                            }
                        }))
                    };
                }
            } catch (error) {
                console.error('ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ ì‹¤íŒ¨:', error);
                // ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©
                scenarioData = {
                    theme: 'kitchen',
                    duration: 120,
                    actions: ACTION_TYPES.slice(0, 15).map((type, index) => ({
                        id: `action_${String(index + 1).padStart(3, '0')}`,
                        type,
                        startTime: index * 8,
                        duration: 8,
                        position: { x: 50, y: 50 },
                        intensity: 'MID',
                        introText: { en: type, ko: getActionKoreanName(type) },
                        images: {
                            off: `https://via.placeholder.com/1920x1080/000000/FFFFFF?text=${type}_OFF`,
                            on: `https://via.placeholder.com/1920x1080/FF6600/FFFFFF?text=${type}_ON`
                        }
                    }))
                };
            }
            
            // ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ë°ì´í„° ë°˜í™˜
            if (!scenarioData) {
                scenarioData = {
                    theme: 'kitchen',
                    duration: 120,
                    actions: ACTION_TYPES.slice(0, 15).map((type, index) => ({
                        id: `action_${String(index + 1).padStart(3, '0')}`,
                        type,
                        startTime: index * 8,
                        duration: 8,
                        position: { x: 50, y: 50 },
                        intensity: 'MID',
                        introText: { en: type, ko: getActionKoreanName(type) },
                        images: {
                            off: `https://via.placeholder.com/1920x1080/000000/FFFFFF?text=${type}_OFF`,
                            on: `https://via.placeholder.com/1920x1080/FF6600/FFFFFF?text=${type}_ON`
                        }
                    }))
                };
            }
            
            return scenarioData;
        }

        // ë™ì‘ í•œê¸€ëª… ë§¤í•‘
        function getActionKoreanName(type) {
            const names = {
                'POINT': 'ì°Œë¥´ê¸°',
                'KNOCK': 'ë‘ë“œë¦¬ê¸°',
                'CHOP': 'ê°€ë¥´ê¸°',
                'TOUCH': 'í„°ì¹˜',
                'PUSH': 'ì‚´ì§ ë°€ê¸°',
                'CLAP': 'ë°•ìˆ˜',
                'PULL': 'ë‹¹ê¸°ê¸°',
                'SWIPE': 'í›‘ê¸°',
                'SNAP': 'ì†ê°€ë½ íŠ•ê¸°ê¸°',
                'GRAB': 'ì›€ì¼œì¥ê¸°',
                'WALK': 'ì œìë¦¬ ê±·ê¸°',
                'JUMP': 'ê°€ë²¼ìš´ ì í”„',
                'LEAN': 'ê¸°ìš¸ì´ê¸°',
                'SHRINK': 'ì›…í¬ë¦¬ê¸°',
                'EXPLODE': 'ì „ì‹  í´ê¸°'
            };
            return names[type] || type;
        }

        // ì§„í–‰ í‘œì‹œ ì´ˆê¸°í™”
        function initProgressIndicator() {
            const container = document.getElementById('progress-indicator');
            container.innerHTML = '';
            for (let i = 0; i < ACTION_TYPES.length; i++) {
                const segment = document.createElement('div');
                segment.className = 'progress-segment';
                segment.id = `segment-${i}`;
                container.appendChild(segment);
            }
        }

        // ì§„í–‰ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateProgressIndicator(index, isActive, isCompleted) {
            const segment = document.getElementById(`segment-${index}`);
            if (!segment) return;
            segment.classList.remove('active', 'completed');
            if (isCompleted) {
                segment.classList.add('completed');
            } else if (isActive) {
                segment.classList.add('active');
            }
        }

        // ì•¡ì…˜ ì¹´ìš´í„° ì—…ë°ì´íŠ¸
        function updateActionCounter(index) {
            const counter = document.getElementById('action-counter');
            if (counter) {
                counter.textContent = `ACTION ${index + 1}/15`;
            }
        }

        const imgOn = document.getElementById('img-on');
        const imgOff = document.getElementById('img-off');
        const startOverlay = document.getElementById('start-overlay');
        const introOverlay = document.getElementById('intro-overlay');

        // ì˜¤ë²„ë ˆì´ë¥¼ ì™„ì „íˆ ì œê±°í•˜ëŠ” í•¨ìˆ˜ (í•œ ë²ˆë§Œ ì‹¤í–‰)
        function removeStartOverlay() {
            if (startOverlay) {
                startOverlay.style.display = 'none';
                startOverlay.style.visibility = 'hidden';
                startOverlay.style.opacity = '0';
                startOverlay.style.pointerEvents = 'none';
                startOverlay.style.position = 'absolute';
                startOverlay.style.zIndex = '-1';
                // DOMì—ì„œ ì™„ì „íˆ ì œê±°
                try {
                    startOverlay.remove();
                } catch (e) {
                    console.warn('ì˜¤ë²„ë ˆì´ ì œê±° ì‹¤íŒ¨:', e);
                }
            }
        }

        async function handleStart() {
            // ì´ë¯¸ ì‹œì‘í–ˆê±°ë‚˜ ì‹œì‘ ì¤‘ì´ë©´ ë¬´ì‹œ (ë¬´í•œ ê¹œë¹¡ê±°ë¦¼ ë°©ì§€)
            if (isStarted || isStarting) {
                console.log('âš ï¸ [Play Phase] ì´ë¯¸ ì‹œì‘í–ˆê±°ë‚˜ ì‹œì‘ ì¤‘ì…ë‹ˆë‹¤');
                return;
            }
            
            console.log('ğŸš€ [Play Phase] handleStart í˜¸ì¶œë¨');
            isStarting = true;
            
            // ì˜¤ë²„ë ˆì´ ì¦‰ì‹œ ì™„ì „íˆ ì œê±° (ê¹œë¹¡ê±°ë¦¼ ë°©ì§€) - ì ˆëŒ€ ë‹¤ì‹œ í‘œì‹œí•˜ì§€ ì•ŠìŒ
            removeStartOverlay();
            
            try {
                // ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„°ê°€ ì´ë¯¸ ë¡œë“œë˜ì—ˆê³  ìœ íš¨í•œì§€ í™•ì¸
                const isScenarioDataValid = scenarioData && 
                                           scenarioData.actions && 
                                           Array.isArray(scenarioData.actions) && 
                                           scenarioData.actions.length > 0;
                
                if (!isScenarioDataValid) {
                    // ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ë¡œë“œ ì‹œë„
                    console.log('ğŸ“¥ ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŒ, ë¡œë“œ ì‹œë„...');
                    try {
                        await loadScenario(scenarioId);
                        
                        // ë¡œë“œ í›„ ë‹¤ì‹œ ê²€ì¦
                        if (!scenarioData || !scenarioData.actions || scenarioData.actions.length === 0) {
                            console.warn('âš ï¸ ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ í›„ì—ë„ ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŒ, ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©');
                            scenarioData = null; // ê¸°ë³¸ ë°ì´í„°ë¡œ ëŒ€ì²´
                        }
                    } catch (error) {
                        console.warn('âš ï¸ ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©:', error);
                        scenarioData = null; // ê¸°ë³¸ ë°ì´í„°ë¡œ ëŒ€ì²´
                    }
                } else {
                    console.log('âœ… ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„°ê°€ ì´ë¯¸ ë¡œë“œë˜ì–´ ìˆìŒ, ì¬ë¡œë“œí•˜ì§€ ì•ŠìŒ');
                }
                
                // ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì•¡ì…˜ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©
                if (!scenarioData || !scenarioData.actions || scenarioData.actions.length === 0) {
                    console.warn('âš ï¸ ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„°ê°€ ì—†ì–´ ê¸°ë³¸ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤');
                    scenarioData = {
                        theme: 'kitchen',
                        duration: 120,
                        actions: ACTION_TYPES.slice(0, 15).map((type, index) => ({
                            id: `action_${String(index + 1).padStart(3, '0')}`,
                            type,
                            startTime: index * 8,
                            duration: 8,
                            position: { x: 50, y: 50 },
                            intensity: 'MID',
                            introText: { en: type, ko: getActionKoreanName(type) },
                            images: {
                                off: `https://via.placeholder.com/1920x1080/000000/FFFFFF?text=${type}_OFF`,
                                on: `https://via.placeholder.com/1920x1080/FF6600/FFFFFF?text=${type}_ON`
                            }
                        }))
                    };
                }

                // ì´ë¯¸ì§€ê°€ ë¹„ì–´ìˆëŠ” ì•¡ì…˜ ì²˜ë¦¬ - "ì´ë¯¸ì§€ ì—†ìŒ" í‘œì‹œìš©
                scenarioData.actions = scenarioData.actions.map(action => {
                    // ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ nullë¡œ ì„¤ì • (ë‚˜ì¤‘ì— "ì´ë¯¸ì§€ ì—†ìŒ" í…ìŠ¤íŠ¸ í‘œì‹œ)
                    if (!action.images || !action.images.off || !action.images.on || 
                        action.images.off === '' || action.images.on === '') {
                        return {
                            ...action,
                            images: {
                                off: null, // ì´ë¯¸ì§€ ì—†ìŒ í‘œì‹œ
                                on: null   // ì´ë¯¸ì§€ ì—†ìŒ í‘œì‹œ
                            },
                            hasNoImage: true // ì´ë¯¸ì§€ ì—†ìŒ í”Œë˜ê·¸
                        };
                    }
                    return action;
                });

                // startActionSequence() í˜¸ì¶œ ì „ ìµœì¢… ê²€ì¦
                if (!scenarioData || !scenarioData.actions || scenarioData.actions.length === 0) {
                    console.error('âŒ ìµœì¢… ê²€ì¦ ì‹¤íŒ¨: scenarioDataê°€ ìœ íš¨í•˜ì§€ ì•ŠìŒ');
                    throw new Error('scenarioData is invalid');
                }

                console.log('âœ… ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ ì™„ë£Œ, ì•¡ì…˜ ìˆ˜:', scenarioData.actions.length, ', ì•¡ì…˜ ì‹œí€€ìŠ¤ ì‹œì‘');
                initProgressIndicator();
                sendPhaseReady();
                startActionSequence();
                isStarted = true;
                isStarting = false;
            } catch (error) {
                console.error('âŒ handleStart ì˜¤ë¥˜:', error);
                // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ê¸°ë³¸ ë°ì´í„°ë¡œ ì‹œì‘
                scenarioData = {
                    theme: 'kitchen',
                    duration: 120,
                    actions: ACTION_TYPES.slice(0, 15).map((type, index) => ({
                        id: `action_${String(index + 1).padStart(3, '0')}`,
                        type,
                        startTime: index * 8,
                        duration: 8,
                        position: { x: 50, y: 50 },
                        intensity: 'MID',
                        introText: { en: type, ko: getActionKoreanName(type) },
                        images: {
                            off: `https://via.placeholder.com/1920x1080/000000/FFFFFF?text=${type}_OFF`,
                            on: `https://via.placeholder.com/1920x1080/FF6600/FFFFFF?text=${type}_ON`
                        }
                    }))
                };
                
                // ì—ëŸ¬ ì¼€ì´ìŠ¤ì—ì„œë„ ìµœì¢… ê²€ì¦
                if (scenarioData && scenarioData.actions && scenarioData.actions.length > 0) {
                    initProgressIndicator();
                    sendPhaseReady();
                    startActionSequence();
                    isStarted = true;
                } else {
                    console.error('âŒ ê¸°ë³¸ ë°ì´í„° ìƒì„±ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                    // ìµœí›„ì˜ ìˆ˜ë‹¨: ì˜¤ë²„ë ˆì´ ë‹¤ì‹œ í‘œì‹œí•˜ì§€ ì•ŠìŒ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
                }
                isStarting = false;
            }
        }

        // ì „ì—­ ë…¸ì¶œ
        window.handleStart = handleStart;

        function startActionSequence() {
            // ìµœì¢… ê²€ì¦: scenarioDataì™€ actionsê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if (!scenarioData) {
                console.error('âŒ startActionSequence: scenarioDataê°€ ì—†ìŠµë‹ˆë‹¤');
                // ê¸°ë³¸ ë°ì´í„° ìƒì„±
                scenarioData = {
                    theme: 'kitchen',
                    duration: 120,
                    actions: ACTION_TYPES.slice(0, 15).map((type, index) => ({
                        id: `action_${String(index + 1).padStart(3, '0')}`,
                        type,
                        startTime: index * 8,
                        duration: 8,
                        position: { x: 50, y: 50 },
                        intensity: 'MID',
                        introText: { en: type, ko: getActionKoreanName(type) },
                        images: {
                            off: `https://via.placeholder.com/1920x1080/000000/FFFFFF?text=${type}_OFF`,
                            on: `https://via.placeholder.com/1920x1080/FF6600/FFFFFF?text=${type}_ON`
                        }
                    }))
                };
            }
            
            if (!scenarioData.actions || !Array.isArray(scenarioData.actions) || scenarioData.actions.length === 0) {
                console.error('âŒ startActionSequence: scenarioData.actionsê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                // ê¸°ë³¸ actions ìƒì„±
                scenarioData.actions = ACTION_TYPES.slice(0, 15).map((type, index) => ({
                    id: `action_${String(index + 1).padStart(3, '0')}`,
                    type,
                    startTime: index * 8,
                    duration: 8,
                    position: { x: 50, y: 50 },
                    intensity: 'MID',
                    introText: { en: type, ko: getActionKoreanName(type) },
                    images: {
                        off: `https://via.placeholder.com/1920x1080/000000/FFFFFF?text=${type}_OFF`,
                        on: `https://via.placeholder.com/1920x1080/FF6600/FFFFFF?text=${type}_ON`
                    }
                }));
            }
            
            console.log('âœ… startActionSequence ì‹œì‘, ì•¡ì…˜ ìˆ˜:', scenarioData.actions.length);
            isRunning = true;
            currentActionIndex = 0;
            executeAction(0);
        }

        function executeAction(index) {
            // ë°©ì–´ ì½”ë“œ: scenarioDataì™€ actions ê²€ì¦
            if (!scenarioData || !scenarioData.actions || !Array.isArray(scenarioData.actions)) {
                console.error('âŒ executeAction: scenarioData.actionsê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                isRunning = false;
                return;
            }
            
            if (index >= scenarioData.actions.length) {
                // ëª¨ë“  ì•¡ì…˜ ì™„ë£Œ
                isRunning = false;
                sendPhaseComplete();
                return;
            }

            const action = scenarioData.actions[index];
            currentActionIndex = index;
            updateActionCounter(index);
            updateProgressIndicator(index, true, false);

            // ì¸íŠ¸ë¡œ í‘œì‹œ
            const introTextEn = document.getElementById('intro-text-en');
            const introTextKo = document.getElementById('intro-text-ko');
            
            if (introTextEn && introTextKo && action.introText) {
                introTextEn.textContent = action.introText.en || action.type;
                introTextKo.textContent = `(${action.introText.ko || getActionKoreanName(action.type)})`;
            }

            introOverlay.style.display = 'flex';

            // 2ì´ˆ í›„ ì¸íŠ¸ë¡œ ìˆ¨ê¸°ê³  ì•¡ì…˜ ì‹œì‘
            setTimeout(() => {
                introOverlay.style.display = 'none';
                startImageToggle(action, index);
            }, config.introTime);
        }

        function startImageToggle(action, actionIndex) {
            // ì´ë¯¸ì§€ê°€ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
            if (action.hasNoImage || !action.images || !action.images.off || !action.images.on || 
                action.images.off === '' || action.images.on === '' || 
                action.images.off === null || action.images.on === null) {
                
                // ì´ë¯¸ì§€ ì—†ìŒ í…ìŠ¤íŠ¸ í‘œì‹œ
                imgOff.style.display = 'none';
                imgOn.style.display = 'none';
                
                // í…ìŠ¤íŠ¸ í‘œì‹œìš© div ìƒì„±
                let noImageDiv = document.getElementById('no-image-text');
                if (!noImageDiv) {
                    noImageDiv = document.createElement('div');
                    noImageDiv.id = 'no-image-text';
                    noImageDiv.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        font-size: 48px;
                        font-weight: bold;
                        color: #ffffff;
                        text-align: center;
                        z-index: 100;
                        background: rgba(0, 0, 0, 0.7);
                        padding: 40px 60px;
                        border-radius: 20px;
                    `;
                    document.body.appendChild(noImageDiv);
                }
                
                const actionName = action.introText?.ko || action.type || 'ì•¡ì…˜';
                noImageDiv.textContent = `${actionName}\nì´ë¯¸ì§€ ì—†ìŒ`;
                noImageDiv.style.display = 'block';
                
                // 8ì´ˆ í›„ ë‹¤ìŒ ì•¡ì…˜ìœ¼ë¡œ
                setTimeout(() => {
                    if (noImageDiv) {
                        noImageDiv.style.display = 'none';
                    }
                    imgOff.style.display = 'block';
                    imgOn.style.display = 'block';
                    updateProgressIndicator(actionIndex, false, true);
                    executeAction(actionIndex + 1);
                }, 8000);
                
                return;
            }
            
            // ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš° ê¸°ì¡´ ë¡œì§
            const offUrl = action.images.off;
            const onUrl = action.images.on;
            
            // ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ
            const offImg = new Image();
            const onImg = new Image();
            
            offImg.src = offUrl;
            onImg.src = onUrl;

            let toggleCount = 0;
            const maxToggles = 20; // 10ì´ˆ = 20ë²ˆ í† ê¸€ (0.5ì´ˆ ê°„ê²©)

            // ì´ˆê¸° ìƒíƒœ: OFF
            imgOff.src = offUrl;
            imgOff.style.display = 'block';
            imgOn.style.display = 'block';
            imgOff.classList.add('image-active');
            imgOn.classList.remove('image-active');

            toggleState = false;

            actionInterval = setInterval(() => {
                if (!isRunning) {
                    clearInterval(actionInterval);
                    return;
                }

                toggleState = !toggleState;
                
                if (toggleState) {
                    imgOn.src = onUrl;
                    imgOn.classList.add('image-active');
                    imgOff.classList.remove('image-active');
                } else {
                    imgOff.src = offUrl;
                    imgOff.classList.add('image-active');
                    imgOn.classList.remove('image-active');
                }

                toggleCount++;

                // ì§„í–‰ë¥  ê³„ì‚° ë° ì „ì†¡ (50% ë„ë‹¬ ì‹œ ì•Œë¦¼)
                const progress = toggleCount / maxToggles;
                if (progress === 0.5 || Math.abs(progress - 0.5) < 0.05) {
                    sendPhaseProgress(progress);
                }

                // 10ì´ˆ ì™„ë£Œ (20ë²ˆ í† ê¸€)
                if (toggleCount >= maxToggles) {
                    clearInterval(actionInterval);
                    updateProgressIndicator(actionIndex, false, true);
                    
                    // ë‹¤ìŒ ì•¡ì…˜ìœ¼ë¡œ
                    setTimeout(() => {
                        executeAction(actionIndex + 1);
                    }, 100);
                }
            }, config.stepTime);
        }

        // ë¸Œë¼ìš°ì € ìºì‹± ë°©ì§€ ë° ì‚¬ì „ ë¡œë“œ
        window.addEventListener('DOMContentLoaded', () => {
            // í† í° ê²€ì¦ (ê°„ë‹¨í•œ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì²´í¬)
            if (!token) {
                const startOverlay = document.getElementById('start-overlay');
                if (startOverlay) {
                    startOverlay.innerHTML = '<div style="color:white;text-align:center;padding:50px;"><h1 style="font-size:24px;margin-bottom:20px;">ì¸ì¦ í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤</h1><p>í† í° ì—†ì´ëŠ” í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                }
                return;
            }
            
            // INIT_PHASE ë©”ì‹œì§€ê°€ ì¼ì • ì‹œê°„ ë‚´ì— ì˜¤ì§€ ì•Šìœ¼ë©´ ìë™ ì‹œì‘
            setTimeout(() => {
                if (!isStarted && !isStarting && !initPhaseReceived) {
                    console.log('âš ï¸ [Play Phase] INIT_PHASE ë©”ì‹œì§€ ë¯¸ìˆ˜ì‹ , ìë™ ì‹œì‘');
                    removeStartOverlay();
                    handleStart();
                }
            }, 1500); // 1.5ì´ˆ í›„ ìë™ ì‹œì‘
        });
    </script>
</body>
</html>
