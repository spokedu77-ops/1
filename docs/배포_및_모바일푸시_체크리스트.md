# 배포 및 모바일 푸시 알림 체크리스트

## 1. 보안 정리

- **의미:** `.env.local`(Firebase API 키, 서비스 계정 JSON, 웹훅 시크릿 등)을 Git에 커밋하지 않음.
- **현재:** `.gitignore`에 `.env*` 포함 → `.env.local`은 Git에 올라가지 않음.
- **방식:** 코드만 `git push`, 비밀은 **Vercel 대시보드 → Environment Variables**에만 등록.

---

## 2. 배포 가능 조건

| 항목 | 설명 |
|------|------|
| 빌드 성공 | `app/lib/fcm.ts`에서 `getApps`/`initializeApp`은 **firebase/app**에서만 import (현재 코드 반영됨) |
| Vercel 환경변수 | 로컬 `.env.local`과 동일한 값들을 프로젝트 Environment Variables에 등록 |
| Supabase 웹훅 URL | 배포 도메인(예: `https://xxx.vercel.app`) 기준으로 설정 |

---

## 3. 배포 전 필수 작업

### 3-1. 빌드 에러 방지 (fcm.ts)

- **파일:** `app/lib/fcm.ts`
- **규칙:** `getApps`, `initializeApp`은 **firebase/app**에서만 import. `getToken`, `getMessaging`은 **firebase/messaging**에서 import.
- **현재 코드 (유지):**
  ```ts
  import { getToken, getMessaging } from 'firebase/messaging';
  import { getApps, initializeApp } from 'firebase/app';
  ```

### 3-2. Vercel 환경변수

Vercel → 프로젝트 → **Settings → Environment Variables**에 아래를 Production(및 필요 시 Preview)에 추가. 값은 로컬 `.env.local`과 동일하게.

**복붙용 (변수명 + 값):** 아래에 각 Value를 채워 넣고, Vercel에 Name / Value 그대로 복붙.

| 변수명 (Name) | 값 (Value) |
|---------------|-------------|
| NEXT_PUBLIC_SUPABASE_URL |  |
| NEXT_PUBLIC_SUPABASE_ANON_KEY |  |
| NEXT_PUBLIC_FIREBASE_API_KEY |  |
| NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN |  |
| NEXT_PUBLIC_FIREBASE_PROJECT_ID |  |
| NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET |  |
| NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID |  |
| NEXT_PUBLIC_FIREBASE_APP_ID |  |
| NEXT_PUBLIC_FIREBASE_VAPID_KEY |  |
| FIREBASE_SERVICE_ACCOUNT_JSON | (JSON 전체 한 줄) |
| SUPABASE_CHAT_PUSH_WEBHOOK_SECRET | (웹훅 Authorization에 쓴 값) |

서비스 계정 JSON에 따옴표가 포함된 값이 있으면 이스케이프하거나, Vercel에서 여러 줄 입력 가능한 경우 그대로 붙여넣기.

---

## 4. 배포 절차

1. **빌드 확인:** 로컬에서 `npm run build` 성공 확인.
2. **Vercel 환경변수:** 위 목록 모두 입력 후 저장.
3. **Git 푸시:** `git add` → `git commit` → `git push` (`.env.local`은 커밋되지 않음).
4. **자동 배포:** Vercel이 연결된 브랜치 push 시 자동 빌드·배포.
5. **웹훅 URL:** Supabase Webhook URL이 배포 URL과 일치하는지 확인 (예: `https://xxx.vercel.app/api/push/send-chat`).

### 4-1. 로컬 개발 시 Turbopack 패닉이 나면

- **원인:** Next.js 16 기본 번들러(Turbopack)가 간헐적으로 내부 패닉을 일으킬 수 있음.
- **1차:** 터미널에서 `npm run dev` 중지(Ctrl+C) 후 `.next` 폴더 삭제, 다시 `npm run dev` 실행.
- **재발 시:** `package.json`의 `dev` 스크립트를 임시로 `"next dev --webpack"`으로 바꿔 사용. (컴파일은 느려지지만 패닉은 없음.)

---

## 5. 모바일 “앱 닫아도 알림” 동작 요약

1. 다른 사용자가 채팅 메시지 INSERT → Supabase Webhook이 `POST /api/push/send-chat` 호출.
2. API에서 참여자 FCM 토큰 조회 후 Firebase FCM으로 푸시 발송.
3. 사용자 기기에서 Service Worker가 푸시 수신 → OS가 알림/진동 표시 (앱 종료 상태에서도 동작).

**필수 조건:**

- 사용자가 채팅 페이지에서 알림 허용 → FCM 토큰이 `user_fcm_tokens`에 저장됨.
- Supabase 웹훅이 배포된 URL을 가리키고, 해당 API에 `FIREBASE_SERVICE_ACCOUNT_JSON` 등 설정됨.
- 모바일에서 HTTPS 배포 URL로 접속 후 알림 허용. “홈 화면에 추가”는 선택이지만 권장.

---

## 5-1. 모바일 알림 설정 — 어디서 켜나요?

**“Safari나 Chrome을 켜야 하나요?” → 아닙니다.**  
홈 화면에 추가한 PWA는 **앱처럼 단일 항목**으로 등록됩니다. 설정 화면에는 **Safari/Chrome이 아니라, manifest에 적힌 앱 이름**이 보입니다.

- **manifest 이름:** `public/manifest.json`의 `short_name`(홈 화면 아이콘 아래 글자) = **"Coach"**, `name` = **"Coach App"**.
- **설정에서 찾을 이름:** 기기/OS에 따라 **"Coach"** 또는 **"Coach App"** 같은 **하나의 앱**으로 표시됩니다. Safari/Chrome 항목을 켜는 게 아니라, **이 단일 항목**에서 알림을 켜야 합니다.

### iOS (iPhone / iPad)

1. **설정** 앱 → **알림** (또는 설정 > 알림).
2. 목록에서 **"Coach"** 또는 **"Coach App"** 항목을 찾습니다. (Safari, Chrome 아래가 아니라 **앱 목록 안의 단일 항목**입니다.)
3. **알림 허용**을 켜고, **배너**, **잠금 화면**, **알림 센터** 등 원하는 표시 방식을 켭니다.
4. **소리**를 켜면 알람 소리가 납니다. **방해 금지 모드**를 쓰면 해당 모드 예외 설정에서 Coach를 허용해야 할 수 있습니다.

> iOS 16.4 이상에서, **홈 화면에 추가**(PWA 설치)한 웹 앱은 manifest에 `display: "standalone"`이 있으면 **별도 앱**으로 알림 목록에 나타납니다. Safari나 Chrome을 켜는 것이 아닙니다.

### Android

1. **설정** → **앱** (또는 앱 및 알림 > 앱).
2. 앱 목록에서 **"Coach"** 또는 **"Coach App"**을 찾습니다. (홈 화면에 추가한 아이콘과 같은 이름입니다.)
3. **알림** (또는 알림 > 알림 유형)에서 **알림 허용**을 켭니다.
4. 필요하면 **채널/카테고리**에서 **소리**, **진동**을 켭니다.

일부 기기에서는 **Chrome** > **사이트 설정** > 해당 사이트 URL > **알림**에서 허용하는 경우도 있지만, 홈 화면에 추가한 PWA는 보통 **Coach(단일 앱)** 로만 나옵니다.

### 정리

| 질문 | 답 |
|------|----|
| Safari나 Chrome을 켜야 하나요? | **아니요.** |
| 스포키듀/Coach 앱 같은 단일 항목으로 나오나요? | **예.** manifest의 이름(Coach / Coach App)으로 **단일 항목**이 됩니다. |
| 그 항목에서 뭘 켜면 되나요? | **알림 허용** + 필요 시 **소리**, **진동**, **배너** 등을 켭니다. |

---

## 5-2. “알림 허용” 팝업이 왜 안 뜨나요? / PWA가 알림 목록에 안 나와요

**PWA는 홈 화면에 추가한다고 해서 알림 권한이 자동으로 켜지지 않습니다.**

### 올바른 순서 (해결 방법)

1. **홈 화면에 추가**한 **Coach 아이콘**을 눌러서 앱을 실행합니다. (브라우저 주소창으로 들어가지 말고, 홈 화면 앱으로 엽니다.)
2. 앱 안에서 **채팅** 탭(메시지 아이콘)을 눌러 **채팅 페이지**로 이동합니다.
3. 이때 우리 앱이 `Notification.requestPermission()`을 호출해서 **“알림을 허용하시겠습니까?”** 브라우저/OS 팝업이 뜹니다.
4. 여기서 **허용**을 눌러야, 그때 비로소 스마트폰 **설정 > 알림** 목록에 **Coach**(또는 Coach App)가 등록됩니다.

즉, “팝업이 없다”면 **홈 화면 아이콘으로 실행한 뒤, 채팅 탭에 한 번 들어가 본 적이 없을 가능성**이 큽니다.  
**정리:** 홈 화면 추가만으로는 알림 목록에 PWA가 안 뜨는 게 정상이고, **앱 실행 → 채팅 탭 진입 → 팝업에서 허용** 후에야 알림 목록에 Coach가 나타납니다.

### 우리 앱에서 팝업이 뜨는 위치

- **선생님:** 하단 네비에서 **채팅** 탭 → 채팅 페이지가 로드될 때 한 번 `Notification.requestPermission()` 호출.
- **관리자:** **채팅** 메뉴로 들어가면 같은 방식으로 호출.

한 번 **거절**했으면 브라우저/OS가 다시 묻지 않을 수 있으므로, 그때는 **설정 > 알림**(또는 **설정 > 사이트 설정 > 알림**)에서 Coach/해당 사이트를 찾아 수동으로 허용해야 합니다.

---

## 5-3. 웹에서는 데이터 나오는데, 홈 화면 PWA로 로그인하면 데이터가 안 나와요

### 원인 (요약)

- **로그인할 때** 사용하는 Supabase 클라이언트는 세션을 **쿠키**에 저장합니다.
- **선생님/관리자 페이지**(채팅, 일정, 메인 등)는 지금까지 **다른** Supabase 클라이언트를 쓰고 있었고, 이 클라이언트는 **localStorage**만 봅니다.
- 그래서 로그인으로 쿠키에는 세션이 들어가 있는데, 선생님/관리자 화면은 localStorage를 보기 때문에 **세션을 못 읽고** → `getUser()`가 null → 데이터를 안 불러옵니다.
- **일반 웹(브라우저 탭)** 에서는 예전에 다른 경로로 localStorage에 세션이 남아 있으면 데이터가 나올 수 있고, **홈 화면 PWA**는 브라우저와 **저장소가 완전히 따로**라서 PWA에서 로그인하면 localStorage 기반 쪽에는 세션이 없어 **데이터가 안 나오는 현상**이 뚜렷합니다.

### 해결 (앱 쪽 수정 사항)

선생님/관리자 영역에서도 **로그인과 같은 쿠키 기반 클라이언트**(`getSupabaseBrowserClient`)를 쓰도록 바꿉니다.  
그러면:

- 로그인 시 쿠키에 저장된 세션을,
- 선생님/관리자 모든 페이지가 **같은 클라이언트**로 읽기 때문에,

**웹이든 PWA(홈 화면 앱)든** 로그인 후 데이터가 동일하게 나옵니다.

---

## 6. 체크리스트 요약

- [ ] `app/lib/fcm.ts`에서 `getApps`/`initializeApp`은 `firebase/app`에서만 import (현재 반영됨).
- [ ] `npm run build` 성공 (로컬에서 실패 시 Vercel 빌드로 확인).
- [ ] Vercel 프로젝트에 위 환경변수 전부 등록 (비밀은 Git 푸시 없이).
- [ ] `git push`로 배포 (`.env.local` 제외됨).
- [ ] Supabase Webhook URL이 배포 URL(`https://xxx.vercel.app/api/push/send-chat`)과 일치하는지 확인.
- [ ] 모바일에서 배포 URL 접속 → 채팅 페이지 → 알림 허용 → 다른 계정으로 메시지 전송 후 앱 종료 상태에서 푸시/진동 확인.
