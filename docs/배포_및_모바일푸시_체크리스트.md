# 배포 및 모바일 푸시 알림 체크리스트

## 1. 보안 정리

- **의미:** `.env.local`(Firebase API 키, 서비스 계정 JSON, 웹훅 시크릿 등)을 Git에 커밋하지 않음.
- **현재:** `.gitignore`에 `.env*` 포함 → `.env.local`은 Git에 올라가지 않음.
- **방식:** 코드만 `git push`, 비밀은 **Vercel 대시보드 → Environment Variables**에만 등록.

---

## 2. 배포 가능 조건

| 항목 | 설명 |
|------|------|
| 빌드 성공 | `app/lib/fcm.ts`에서 `getApps`/`initializeApp`은 **firebase/app**에서만 import (현재 코드 반영됨) |
| Vercel 환경변수 | 로컬 `.env.local`과 동일한 값들을 프로젝트 Environment Variables에 등록 |
| Supabase 웹훅 URL | 배포 도메인(예: `https://xxx.vercel.app`) 기준으로 설정 |

---

## 3. 배포 전 필수 작업

### 3-1. 빌드 에러 방지 (fcm.ts)

- **파일:** `app/lib/fcm.ts`
- **규칙:** `getApps`, `initializeApp`은 **firebase/app**에서만 import. `getToken`, `getMessaging`은 **firebase/messaging**에서 import.
- **현재 코드 (유지):**
  ```ts
  import { getToken, getMessaging } from 'firebase/messaging';
  import { getApps, initializeApp } from 'firebase/app';
  ```

### 3-2. Vercel 환경변수

Vercel → 프로젝트 → **Settings → Environment Variables**에 아래를 Production(및 필요 시 Preview)에 추가. 값은 로컬 `.env.local`과 동일하게.

**복붙용 (변수명 + 값):** 아래에 각 Value를 채워 넣고, Vercel에 Name / Value 그대로 복붙.

| 변수명 (Name) | 값 (Value) |
|---------------|-------------|
| NEXT_PUBLIC_SUPABASE_URL |  |
| NEXT_PUBLIC_SUPABASE_ANON_KEY |  |
| NEXT_PUBLIC_FIREBASE_API_KEY |  |
| NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN |  |
| NEXT_PUBLIC_FIREBASE_PROJECT_ID |  |
| NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET |  |
| NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID |  |
| NEXT_PUBLIC_FIREBASE_APP_ID |  |
| NEXT_PUBLIC_FIREBASE_VAPID_KEY |  |
| FIREBASE_SERVICE_ACCOUNT_JSON | (JSON 전체 한 줄) |
| SUPABASE_CHAT_PUSH_WEBHOOK_SECRET | (웹훅 Authorization에 쓴 값) |

서비스 계정 JSON에 따옴표가 포함된 값이 있으면 이스케이프하거나, Vercel에서 여러 줄 입력 가능한 경우 그대로 붙여넣기.

---

## 4. 배포 절차

1. **빌드 확인:** 로컬에서 `npm run build` 성공 확인. (프로젝트는 `next build --webpack` 사용으로 Turbopack symlink 이슈 회피.)
2. **Vercel 환경변수:** 위 목록 모두 입력 후 저장.
3. **Git 푸시:** `git add` → `git commit` → `git push` (`.env.local`은 커밋되지 않음).
4. **자동 배포:** Vercel이 연결된 브랜치 push 시 자동 빌드·배포.
5. **웹훅 URL:** Supabase Webhook URL이 배포 URL과 일치하는지 확인 (예: `https://xxx.vercel.app/api/push/send-chat`).

---

## 5. 모바일 “앱 닫아도 알림” 동작 요약

1. 다른 사용자가 채팅 메시지 INSERT → Supabase Webhook이 `POST /api/push/send-chat` 호출.
2. API에서 참여자 FCM 토큰 조회 후 Firebase FCM으로 푸시 발송.
3. 사용자 기기에서 Service Worker가 푸시 수신 → OS가 알림/진동 표시 (앱 종료 상태에서도 동작).

**필수 조건:**

- 사용자가 채팅 페이지에서 알림 허용 → FCM 토큰이 `user_fcm_tokens`에 저장됨.
- Supabase 웹훅이 배포된 URL을 가리키고, 해당 API에 `FIREBASE_SERVICE_ACCOUNT_JSON` 등 설정됨.
- 모바일에서 HTTPS 배포 URL로 접속 후 알림 허용. “홈 화면에 추가”는 선택이지만 권장.

---

## 6. 체크리스트 요약

- [ ] `app/lib/fcm.ts`에서 `getApps`/`initializeApp`은 `firebase/app`에서만 import (현재 반영됨).
- [ ] `npm run build` 성공 (로컬에서 실패 시 Vercel 빌드로 확인).
- [ ] Vercel 프로젝트에 위 환경변수 전부 등록 (비밀은 Git 푸시 없이).
- [ ] `git push`로 배포 (`.env.local` 제외됨).
- [ ] Supabase Webhook URL이 배포 URL(`https://xxx.vercel.app/api/push/send-chat`)과 일치하는지 확인.
- [ ] 모바일에서 배포 URL 접속 → 채팅 페이지 → 알림 허용 → 다른 계정으로 메시지 전송 후 앱 종료 상태에서 푸시/진동 확인.
