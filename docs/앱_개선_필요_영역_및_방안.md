# 앱 개선 필요 영역 및 디벨롭 방안

남은 이슈(teachers-classes 캐스팅, 미사용 변수 등)는 제외하고, **코드·문서·배포 검수 내용을 근거로** 개선이 필요한 부분과 구체적 방안만 정리했습니다.

---

## 1. 빌드·배포 품질 (배포 통과 ≠ 품질 검증)

### 근거

- [docs/PWA_및_전체_개선_보고서.md](PWA_및_전체_개선_보고서.md) 0절: “TS 타입 에러가 나도 빌드가 실패하지 않는다”, “배포 통과 ≠ 동작/품질 검증”.
- [docs/VERCEL_배포_검수.md](VERCEL_배포_검수.md): `ignoreBuildErrors` / `ignoreDuringBuilds` 사용 시 린트·타입 오류로 빌드가 막히지 않음.
- [next.config.ts](next.config.ts): 현재 `typescript: { ignoreBuildErrors: false }`만 명시. 다른 브랜치나 과거 설정에서 `true`였을 가능성 있음.

### 개선 방안

1. **배포 브랜치의 next.config.ts 확인**  
   - `typescript.ignoreBuildErrors`, `eslint.ignoreDuringBuilds`가 `true`로 되어 있으면 제거 또는 `false`로 변경.
2. **CI에서 품질 검사 분리**  
   - Vercel 빌드 전/후에 `npx tsc --noEmit`, `npm run lint`를 실행하는 단계를 추가해, “빌드는 되지만 타입/린트 오류가 있는 상태”로 배포되지 않도록 함.
3. **문서 정리**  
   - “배포 성공 ≠ 품질 검증”을 배포 체크리스트에 명시하고, 위 옵션 제거·CI 추가 시점을 기록.

---

## 2. Supabase 클라이언트 사용처 일원화 (PWA·세션 안정성)

### 근거

- [docs/PWA_및_전체_개선_보고서.md](PWA_및_전체_개선_보고서.md) 1-1절: “로그인은 쿠키 기반 `getSupabaseBrowserClient()`를 쓰는데, 일부 코드는 `createClient()` / `getSupabaseClient()` 사용. PWA는 저장소가 분리되어 쿠키만 있으면 localStorage 클라이언트가 세션을 못 읽음.”
- 코드 검색 결과:
  - **페이지·레이아웃**: admin/teacher 대부분은 이미 `getSupabaseBrowserClient()` 사용 ([app/admin/page.tsx](app/admin/page.tsx), [app/teacher/page.tsx](app/teacher/page.tsx), [app/admin/iiwarmup/scheduler/page.tsx](app/admin/iiwarmup/scheduler/page.tsx) 등).
  - **lib/admin**: [loadThemeAssets.ts](app/lib/admin/assets/loadThemeAssets.ts) 10행 `const supabase = getSupabaseClient()`, [useRotationSchedule.ts](app/lib/admin/hooks/useRotationSchedule.ts), [useThink150Pack.ts](app/lib/admin/hooks/useThink150Pack.ts), [useChallengeBGM.ts](app/lib/admin/hooks/useChallengeBGM.ts), [useThinkAssets.ts](app/lib/admin/hooks/useThinkAssets.ts), [usePlayAssets.ts](app/lib/admin/hooks/usePlayAssets.ts), [storageClient.ts](app/lib/admin/assets/storageClient.ts), [actionCatalog.ts](app/lib/admin/actions/actionCatalog.ts) 등에서 `getSupabaseClient()` 사용.
- [app/lib/supabase/client.ts](app/lib/supabase/client.ts): 브라우저에서는 `getSupabaseClient()`가 `getSupabaseBrowserClient()`를 반환하므로, **현재 동작은 브라우저에서 대부분 정상**일 수 있음. 다만 의도가 “반드시 쿠키 세션”인 곳은 클라이언트를 명시하는 편이 안전함.

### 개선 방안

1. **클라이언트 전용 데이터 접근의 명시**  
   - admin/teacher에서 호출하는 훅·유틸(에셋 로드, 스케줄, BGM 등)이 “브라우저에서만 실행되고 쿠키 세션을 써야 한다”면, 해당 훅/함수 내부에서 `getSupabaseClient()` 대신 `getSupabaseBrowserClient()`를 사용하도록 변경.  
   - 또는 호출하는 페이지에서 `getSupabaseBrowserClient()`를 인자로 넘기고, 훅/유틸은 `SupabaseClient`를 인자로 받도록 리팩터.
2. **모듈 최상단 `const supabase = getSupabaseClient()` 제거**  
   - [loadThemeAssets.ts](app/lib/admin/assets/loadThemeAssets.ts), [storageClient.ts](app/lib/admin/assets/storageClient.ts), [actionCatalog.ts](app/lib/admin/actions/actionCatalog.ts) 등은 함수/쿼리 실행 시점에 클라이언트를 얻도록 변경(`getSupabaseClient()` 또는 위처럼 브라우저 클라이언트 주입).  
   - SSR/빌드 시 해당 모듈이 로드되면 서버 클라이언트가 생성되는 구조를 피할 수 있음.
3. **API 라우트는 서버 전용 유지**  
   - [app/api/admin/schedule/route.ts](app/api/admin/schedule/route.ts), [app/api/sessions/auto-finish/route.ts](app/api/sessions/auto-finish/route.ts) 등은 `createClient(serviceKey)` 등 서버용 클라이언트 유지. 문서에 “클라이언트만 브라우저 클라이언트로 통일, API는 서버용”이라고 명시.

---

## 3. React 훅·렌더 패턴 (set-state-in-effect, exhaustive-deps)

### 근거

- [docs/PWA_및_전체_개선_보고서.md](PWA_및_전체_개선_보고서.md) 2-1절: “set-state-in-effect는 연쇄 렌더/버벅거림으로 이어질 수 있어 우선 수정.”
- 코드 내 `eslint-disable` 사용처:  
  [app/page.tsx](app/page.tsx), [app/teacher/curriculum/page.tsx](app/teacher/curriculum/page.tsx), [app/admin/inventory/page.tsx](app/admin/inventory/page.tsx), [app/teacher/inventory/page.tsx](app/teacher/inventory/page.tsx) — set-state-in-effect;  
  [app/admin/curriculum/page.tsx](app/admin/curriculum/page.tsx), [app/admin/classes/page.tsx](app/admin/classes/page.tsx) — exhaustive-deps;  
  [app/components/admin/scheduler/SchedulerSlotCard.tsx](app/components/admin/scheduler/SchedulerSlotCard.tsx), [app/components/subscriber/FullSequencePlayer.tsx](app/components/subscriber/FullSequencePlayer.tsx) 등.

### 개선 방안

1. **마운트 1회 fetch 패턴**  
   - “마운트 시 1회만 데이터 fetch”는 유지하되, effect 안에서 setState를 유발하는 호출을 **한 틱 지연** (`queueMicrotask`/`setTimeout(..., 0)`) 하거나, 데이터 fetch를 훅으로 분리해 `useEffect` 의존성을 명확히 한 뒤, 필요 시에만 eslint 예외를 유지.  
   - 예외 주석에 “mount-only data fetch” 등 이유를 반드시 명시(이미 일부 적용됨).
2. **exhaustive-deps**  
   - 의존성 배열에 넣으면 무한 루프나 불필요 리페치가 나는 경우, ref로 “최신 값만 참조”하고 deps에는 넣지 않는 패턴으로 정리한 뒤, 남는 예외만 최소한으로 둠.
3. **점진 적용**  
   - 새 코드에서는 set-state-in-effect/exhaustive-deps 예외를 넣지 않고, 기존 페이지는 우선순위(체감 버벅거림, 자주 쓰는 플로우) 순으로 리팩터.

---

## 4. 타입 안전성·Supabase 쿼리 타입

### 근거

- [app/admin/teachers-classes/page.tsx](app/admin/teachers-classes/page.tsx) 140행: `setSessions(data as unknown as Session[])` — Supabase join 결과를 수동 인터페이스 `Session`으로 강제 캐스팅.
- 프로젝트 전역에서 Supabase 생성 타입(Database, Tables, Row 등) 사용처 없음. 테이블/뷰 변경 시 타입이 자동으로 반영되지 않음.

### 개선 방안

1. **Supabase 타입 생성 도입**  
   - `supabase gen types typescript` 등으로 `Database` 타입 생성 후, `createClient<Database>()` / `getSupabaseBrowserClient()` 반환 타입에 반영.  
   - `.select('id, title, ...')` 결과를 제네릭으로 추론하게 하면 `as unknown as Session[]` 같은 캐스팅을 줄일 수 있음.
2. **수동 인터페이스와의 병행**  
   - 기존 `Session`, `Coach` 등은 그대로 두고, Supabase 쿼리 반환 타입을 `Database['public']['Tables']['sessions']['Row']` 등으로 점진 대체.  
   - join 결과는 `Database['public']['Views']` 또는 커스텀 타입으로 정의 후 쿼리 제네릭에 연결.
3. **teachers-classes**  
   - 위 타입 생성 후 해당 쿼리에 제네릭을 적용하고, `setSessions(data ?? [])` 정도로만 두고 이중 캐스팅 제거.

---

## 5. API·서버 (Storage RLS, 서버 전용 클라이언트)

### 근거

- [docs/PWA_및_전체_개선_보고서.md](PWA_및_전체_개선_보고서.md) 4-1절: [app/api/admin/storage/exists/route.ts](app/api/admin/storage/exists/route.ts)가 `getSupabaseClient()` 사용. 서버에서는 쿠키가 없어 anon만 적용되며, Storage RLS가 “인증 필요”면 실패할 수 있음.

### 개선 방안

1. **Storage exists API**  
   - RLS 정책이 “인증된 사용자만”이면, API 라우트에서만 사용하는 **서버 전용 클라이언트**(예: service role 또는 쿠키/헤더에서 세션을 복원한 뒤 해당 세션으로 클라이언트 생성)를 사용하도록 변경.  
   - 사용처가 “로그인된 admin만”이면, Next 미들웨어나 라우트에서 세션 검사 후 호출하도록 문서화.
2. **일관된 서버 클라이언트 정책**  
   - 서버에서 DB/Storage 접근 시 “anon vs service role vs 세션 복원” 중 어떤 방식을 쓰는지 문서에 정리하고, 새 API 추가 시 같은 패턴을 따르도록 함.

---

## 6. 프로덕션 품질 (로그, 미사용 코드)

### 근거

- [docs/PWA_및_전체_개선_보고서.md](PWA_및_전체_개선_보고서.md) 3-1, 3-2: admin inventory/users 등에 `console.log` 존재 가능성, `no-unused-vars` 경고(미사용 변수/import) 다수.
- [app/admin/classes/page.tsx](app/admin/classes/page.tsx) 780행: `console.warn('eventContent render error', err)` 등 에러/경고 로그.

### 개선 방안

1. **console**  
   - 프로덕션에서만 숨기려면 `process.env.NODE_ENV === 'development'`로 감싸기.  
   - 에러/경고는 유지하되, 개인정보·과도한 페이로드는 제거하거나 마스킹.
2. **미사용 변수/import**  
   - 린트로 목록 확보 후, “추후 사용 예정”이면 `_` 접두이 또는 eslint-disable 한 줄, 사용 계획 없으면 제거.  
   - 문서에 “의도적 미사용” 규칙 한 줄 정리.

---

## 7. 요약 표

| 영역 | 근거 요약 | 디벨롭 방향 |
|------|-----------|-------------|
| 빌드·배포 품질 | 문서상 ignoreBuildErrors/ignoreDuringBuilds, “배포≠품질 검증” | next.config 무시 옵션 제거, CI에 tsc/lint 추가, 문서 정리 |
| Supabase 클라이언트 | PWA 세션 문서, lib/admin 다수 getSupabaseClient() | 클라이언트 전용은 getSupabaseBrowserClient() 명시, 모듈 최상단 supabase 제거 |
| React 훅 | set-state-in-effect, exhaustive-deps, 다수 eslint-disable | 마운트 fetch 패턴 정리, deps/ref 패턴 정리, 새 코드부터 예외 최소화 |
| 타입·쿼리 | teachers-classes 이중 캐스팅, Supabase 생성 타입 미사용 | supabase gen types 도입, 쿼리 제네릭으로 캐스팅 축소 |
| API·서버 | storage exists RLS, 서버용 클라이언트 | 서버 전용 클라이언트·RLS 정책 정리, 문서화 |
| 로그·미사용 | console.log/warn, no-unused-vars | NODE_ENV 감싸기, 미사용 제거/접두이 규칙 |

위 항목은 “기능·동작을 바꾸지 않는” 범위를 넘어서는 부분도 포함되어 있으나, 근거와 방안을 맞춰 두었으므로 우선순위(예: PWA 세션 → 빌드 품질 → 타입 → 로그)에 따라 단계적으로 적용할 수 있습니다.
