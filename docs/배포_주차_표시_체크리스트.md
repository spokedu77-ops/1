# 배포 환경에서 "2월 2주차"가 안 뜨는 경우 체크리스트

## 동작 방식
- 구독자 페이지(iwarmup)는 **주차(weekKey)** 예: `2025-02-W2` (2월 2주차)로 `/api/schedule/[weekKey]` 호출
- API는 **Vercel 서버**에서 실행되며, **Vercel에 설정된 환경 변수**로 Supabase 접속
- `rotation_schedule` 테이블에서 `week_key = '2025-02-W2'` 이고 **`is_published = true`** 인 행이 있어야 "이번 주 프로그램"이 표시됨

---

## ⚠️ DB(2번)는 정상인데 배포에서만 안 뜨는 경우 → 대부분 이거

### 원인: Vercel에 **SUPABASE_SERVICE_ROLE_KEY** 가 없음

- `/api/schedule/[weekKey]` 는 **서비스 역할 키(service_role)** 가 있으면 RLS 없이 DB를 읽음.
- **서비스 역할 키가 없으면** API가 **anon 키**로 fallback 하고, **RLS 정책** 때문에 `rotation_schedule` / `warmup_programs_composite` 를 못 읽어서 빈 응답이 나감.
- 로컬에서는 `.env.local` 에 `SUPABASE_SERVICE_ROLE_KEY` 가 있어서 정상 동작하고, Vercel에는 이 값을 안 넣었을 때 이런 차이가 남.

### 해결

1. Vercel → 해당 프로젝트 → **Settings** → **Environment Variables**
2. 다음 변수 추가 (로컬과 같은 Supabase 프로젝트 값 사용):
   - `NEXT_PUBLIC_SUPABASE_URL` = Supabase 프로젝트 URL
   - `SUPABASE_SERVICE_ROLE_KEY` = Supabase **Project Settings → API → service_role (secret)** 값
   - (필요 시) `NEXT_PUBLIC_SUPABASE_ANON_KEY` 도 있으면 유지
3. **Production** (및 사용하는 환경)에 적용 후 **재배포** (Redeploy).

재배포 후에도 안 되면 브라우저에서 `https://[배포도메인]/api/schedule/2025-02-W2` 호출해서 응답 JSON에 `is_published` / `phases` 가 들어오는지 확인.

---

## 1. 배포 환경과 로컬이 같은 DB를 쓰는지 확인
- **로컬**: `.env.local` 의 `NEXT_PUBLIC_SUPABASE_URL` / `SUPABASE_SERVICE_ROLE_KEY`
- **배포**: Vercel 프로젝트 → Settings → Environment Variables
- 두 곳이 **같은 Supabase 프로젝트**를 가리키고, **배포에도 SUPABASE_SERVICE_ROLE_KEY 가 반드시 있음**.

## 2. 해당 주차가 배포용 DB에 발행되어 있는지 확인
- Supabase 대시보드 → Table Editor → **rotation_schedule**
- `week_key` = `2025-02-W2` (또는 원하는 2월 2주차 키) 인 행이 있는지 확인
- 해당 행의 **is_published** = **true** 인지 확인

## 3. API가 배포에서 정상 응답하는지 확인
- `https://[배포도메인]/api/schedule/2025-02-W2` 로 직접 호출
- 응답에 `is_published: true` 이고 `phases` / `challengePhases` 등이 비어 있지 않은지 확인

## 4. 요약
| 확인 항목 | 내용 |
|----------|------|
| **서비스 역할 키** | Vercel에 **SUPABASE_SERVICE_ROLE_KEY** 반드시 설정 (없으면 anon+RLS로 빈 응답) |
| 환경 변수 | 같은 Supabase 프로젝트의 URL/키 사용 |
| DB 데이터 | `rotation_schedule` 해당 `week_key` + **is_published = true** |
| API 응답 | 배포 URL로 `/api/schedule/2025-02-W2` 호출해 본문 확인 |
