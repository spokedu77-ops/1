# 사용자 페이지(전체 재생) 로딩이 오래 걸리는 이유

파일이 무겁거나 코드가 복잡해서가 아니라, **서버·네트워크에서 기다리는 시간**이 길어서 그렇습니다.

---

## 1. 실제로 일어나는 일 (흐름)

1. 사용자가 `/iiwarmup` 접속
2. 페이지가 로드되자마자 `GET /api/schedule/2025-02-W2` 호출 (React Query)
3. **이 API가 Vercel 서버에서 실행됨** → 여기서 대부분의 시간이 걸림
4. API가 끝나야 화면에 "이번 주 프로그램" / "전체 재생"이 뜸

즉, **페이지 로딩 시간 ≈ (HTML/JS 받는 시간) + (API 한 번 끝날 때까지 기다리는 시간)** 이고,  
체감상 느린 건 거의 다 **3번 API 응답을 기다리는 시간**입니다.

---

## 2. API가 느린 이유 (시간이 쓰이는 곳)

### (1) Vercel 서버리스 콜드스타트 (가장 큼)

- `/api/schedule/[weekKey]` 는 **서버리스 함수**입니다.
- 한동안 아무도 이 API를 안 부르면, Vercel이 그 함수를 **내려놓음**.
- 그다음 **첫 요청**이 들어오면:
  - 서버 하나 깨우기
  - Node.js 올리기
  - 코드 실행 준비  
  → 이 단계만 **1~5초** 넘게 걸릴 수 있음 (플랜/리전에 따라 다름).
- 두 번째 요청부터는 이미 깨워진 서버를 쓰니까 훨씬 빨라짐.

**정리:** “가끔 들어오면 엄청 느리고, 연달아 들어오면 괜찮다”면 거의 콜드스타트 때문입니다.

---

### (2) Vercel ↔ Supabase 네트워크 왕복 (두 번째로 큼)

- API는 **Vercel 서버**에서 돌고, 데이터는 **Supabase**에 있습니다.
- DB에서 뭔가 하나 조회할 때마다:
  - Vercel → 인터넷 → Supabase → 다시 Vercel  
  → 한 번 왕복에 **수십 ms ~ 200ms 이상** (리전이 다르면 더 김).
- 지금 API는 **최소 2번의 “왕복 단계”**가 있습니다.
  - 1단계: BGM 설정 + Think 팩 + `rotation_schedule` (3개 병렬) → **1번 왕복**
  - 2단계: 해당 주차 있으면 program + challenge (2개 병렬) → **1번 왕복**
- 그래서 DB만 따져도 **수백 ms ~ 1초**는 쉽게 나옵니다.

**정리:** 파일 크기랑 상관없이, “서버가 DB 몇 번 찌르느냐”와 “Vercel–Supabase 거리”가 시간을 잡아먹습니다.

---

### (3) API가 하는 일 (DB 호출 횟수)

- 2월 2주차 한 번 불러오는데:
  - `think_asset_packs` 2번 (BGM, Think 팩)
  - `rotation_schedule` 1번
  - `warmup_programs_composite` 2번 (program, challenge)
- 이미 병렬로 줄여둔 상태라, **같은 구조를 유지하는 한** 더 크게 줄이려면:
  - 스케줄+프로그램을 한 번에 주는 뷰/함수 만들기
  - 또는 캐시(CDN/ISR 등)로 API 자체를 덜 부르기  
  같은 식의 구조 변경이 필요합니다.

**정리:** “파일이 무겁지 않다”는 말이 맞고, 느린 건 **API가 서버/DB에서 기다리는 시간**입니다.

---

## 3. “2월 2주차에 아무것도 없다”는 건 다른 문제 (데이터/설정)

로딩이 느린 것과, **2주차 프로그램이 안 뜨는 것**은 별개입니다.

- API가 **200 OK**로 끝나도,  
  `program_snapshot`, `phases`, `challengePhases` 가 비어 있거나  
  `is_published: false` 이면 화면에는 **“이번 주에 배정된 프로그램이 없어요”** 로 나옵니다.
- 그럴 수 있는 경우:
  1. **DB에 해당 주차가 없음**  
     - `rotation_schedule` 에 `week_key = '2025-02-W2'` 인 행이 없음.
  2. **있는데 비공개**  
     - 해당 행의 `is_published = false`.
  3. **배포 환경에서 DB를 못 읽음**  
     - Vercel에 `SUPABASE_SERVICE_ROLE_KEY` 가 없으면 anon 키로 읽게 되고,  
     - RLS 때문에 `rotation_schedule` / `warmup_programs_composite` 를 못 읽어서  
     - 빈 응답이 나갈 수 있음.

로컬에서는 되는데 배포에서만 2주차가 없다면, 위 3번(환경 변수) + 1·2번(DB 데이터)을 먼저 확인하는 게 맞습니다.  
(체크리스트: `docs/배포_주차_표시_체크리스트.md`)

---

## 4. 요약

| 질문 | 답 |
|------|----|
| 왜 전체 재생 페이지 로딩이 오래 걸리나? | **API 한 번**(`/api/schedule/2025-02-W2`)이 끝날 때까지 기다리기 때문. |
| 파일이 무거워서? | 아님. **서버가 깨우는 시간(콜드스타트)** + **Vercel↔Supabase 왕복** 때문에 느린 것. |
| 뭘 줄이면 빨라지나? | (1) 콜드스타트: 트래픽이 조금이라도 자주 오거나, 웜업/프리미엄 플랜 등 (2) 왕복: API 호출 횟수 줄이기·캐시 쓰기 (3) 같은 주차 재방문 시: 이미 적용한 Cache-Control 로 두 번째부터는 조금 나아짐. |

즉, **부족하거나 어려워서**라기보다는,  
**서버 한 번 깨우기 + DB 몇 번 왕복**이라는 구조 때문에 시간이 오래 걸리는 겁니다.
