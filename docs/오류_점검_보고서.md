# coach-app 오류 점검 보고서

전체 앱을 점검한 결과입니다. 기능적으로 작동하지 않거나 크래시 가능성이 있는 부분을 우선순위별로 정리했습니다.

---

## 1. HIGH 심각도 — 즉시 수정 권장

### 1.1 `.single()` 호출 후 error 미체크 → null 접근 크래시

| 파일 | 라인 | 문제 | 수정 방향 |
|------|------|------|-----------|
| `app/report/[id]/page.tsx` | 30-36 | `{ data }`만 사용, `error` 미체크. PGRST116(행 없음) 시 `data`가 null이어도 `setSession(data)` 후 `session` null로 렌더 시 "리포트를 찾을 수 없습니다" 표시. 에러(네트워크 등) 시 사용자 피드백 없음 | `error` 체크 후 `toast.error` 또는 에러 UI |
| `app/teacher/report/page.tsx` | 50 | `userData`가 null이면 `setTeacher(userData)` → 이후 `teacher` 접근 시 크래시 가능 | `error` 체크, null 시 로그아웃/에러 페이지 |
| `app/teacher/inventory/page.tsx` | 51 | `userData` null이어도 `setUserName(userData.name)` → 크래시 | `error` 체크, optional chaining |
| `app/admin/users/page.tsx` | 85 | `me`가 null이어도 사용 | `error` 체크, null 시 리다이렉트 |
| `app/components/admin/MileageDetailModal.tsx` | 131, 157, 180 | `user` null이면 `currentPoints = user?.points ?? 0` → 0으로 계산. 포인트 차감/추가 로직이 잘못된 값 사용 | `error` 체크, 실패 시 toast 및 중단 |
| `app/admin/classes/page.tsx` | 144-150, 286, 346-350 | `user` null 시 `session_count`/`points` 업데이트가 0 기준으로 잘못 계산 | `error` 체크, 실패 시 롤백 또는 toast |

### 1.2 profiles vs users 테이블

| 파일 | 문제 |
|------|------|
| `app/page.tsx` | `profiles` 테이블 사용. `error` 미체크 |
| `app/login/page.tsx` | `profiles` 사용. `profile?.role` 사용으로 null 안전 |
| `app/admin/layout.tsx` | `profiles` 사용. `profileError` 체크 있음 (OK) |

→ `profiles`가 Supabase에 존재하는지 확인. `sync-by-email` API는 `profiles.upsert` 사용. `profiles` 없으면 로그인/권한 체크 실패.

### 1.3 session_count_logs INSERT 권한

- `app/admin/classes/page.tsx`의 `autoFinishSessions`는 클라이언트에서 `session_count_logs`에 INSERT 시도.
- RLS 정책이 **관리자만 INSERT**로 변경됨 → teacher로 로그인한 상태에서 auto-finish 실행 시 INSERT 실패.
- **현재**: `autoFinishSessions`는 admin/classes 페이지에서만 호출되므로, admin 로그인 시에는 동작 가능.
- **확인 필요**: `/api/sessions/auto-finish` CRON이 Service Role을 쓰는지. Service Role이면 RLS 우회되어 정상 동작.

---

## 2. MEDIUM 심각도 — 단기 수정 권장

### 2.1 API 호출 실패 시 사용자 피드백 없음

| 파일 | 라인 | 문제 |
|------|------|------|
| `app/admin/page.tsx` | 95 | `fetch('/api/admin/hq-todos')` 실패 시 `[]` 반환, 에러 표시 없음 |
| `app/admin/page.tsx` | 240-246 | `toggleStatus` fetch 실패 시 `res.ok`만 체크, toast 없음 |
| `app/admin/page.tsx` | 251 | `handleSaveTask`는 toast 있음 (OK) |
| `app/admin/classes/page.tsx` | 155-157 | `autoFinishSessions` catch에서 `console.error`만, 사용자 피드백 없음 |

### 2.2 날짜 파싱 유효성

| 파일 | 라인 | 문제 |
|------|------|------|
| `app/admin/classes/page.tsx` | 248-249 | `new Date(y, m-1, d, hh, mm)` 파싱 실패 시 Invalid Date가 DB에 저장될 수 있음 |

### 2.3 RLS 정책 변경 후 접근 거부 가능성

다음 페이지들은 Supabase 클라이언트로 테이블 직접 접근. RLS가 강화되면 접근 거부 가능:

| 테이블 | 사용 페이지 |
|--------|------------|
| `personal_curriculum` | `app/teacher/curriculum/page.tsx` |
| `session_count_logs` | `app/admin/users/CountingTab.tsx` |
| `inventory`, `inventory_logs` | `app/teacher/inventory/page.tsx`, `app/admin/inventory/page.tsx` |
| `lesson_plans` | `app/teacher/my-classes/page.tsx`, `app/admin/notice/page.tsx` |
| `weekly_best` | `app/teacher/page.tsx`, `app/admin/notice/page.tsx` |
| `users`, `sessions`, `schedules` | `app/admin/page.tsx`, `app/admin/classes/page.tsx` |
| `mileage_logs` | `app/components/admin/MileageDetailModal.tsx`, `app/teacher/report/page.tsx` |

→ admin 페이지는 admin RLS로 접근 가능해야 함. teacher 페이지는 본인 데이터만 접근 가능해야 함. 현재 RLS 정책과 일치하는지 검증 필요.

---

## 3. LOW 심각도 — 개선 권장

### 3.1 redirects

- `/admin/mileage` → `/admin/users?tab=counting` (정상)
- `/admin/chat`, `/teacher/chat`, `/teacher/notice` → 각각 `/admin`, `/teacher` (의도된 리다이렉트)

### 3.2 환경변수

- `SUPABASE_SERVICE_ROLE_KEY`, `CRON_SECRET` 등 누락 시 API 500 에러. `.env.example`에 명시되어 있는지 확인 권장.

---

## 4. 수정 우선순위 요약

1. **즉시**: `app/report/[id]/page.tsx`, `app/teacher/report/page.tsx`, `app/teacher/inventory/page.tsx`, `MileageDetailModal.tsx` — `.single()` error 체크 및 null 처리
2. **단기**: `app/admin/classes/page.tsx` — `user` 조회 error 체크, `autoFinishSessions` 에러 피드백
3. **단기**: `app/admin/page.tsx` — hq-todos fetch 실패 시 toast
4. **검증**: `profiles` vs `users` 테이블 사용처 확인
5. **검증**: RLS 정책과 각 페이지 접근 패턴 일치 여부 확인
